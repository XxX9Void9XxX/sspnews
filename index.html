<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SSPNews Live Editor (Secure)</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  #editor { border: 1px solid #ccc; min-height: 300px; padding: 10px; margin-bottom: 10px; }
  #save { padding: 5px 10px; }
  #status { margin-top: 10px; }
</style>
</head>
<body>

<h1>SSPNews Editor</h1>
<div id="editor" contenteditable="false">Loading content...</div>
<button id="save" style="display:none;">Save Changes</button>
<p id="status"></p>

<script>
const username = "XxX9Void9XxX"; 
const repo = "sspnews"; 
const path = "content.json"; 
const branch = "main"; 

const editor = document.getElementById("editor");
const saveBtn = document.getElementById("save");
const status = document.getElementById("status");

let token = null;  // Token is empty by default

// ==== ADMIN LOGIN ====
function promptAdmin() {
  const input = prompt("Enter your admin token to edit (kept private):");
  if(input) {
    token = input;
    editor.contentEditable = true;
    saveBtn.style.display = "inline-block";
    status.innerText = "You can now edit!";
  } else {
    status.innerText = "Read-only mode for visitors.";
  }
}

// ==== LOAD CONTENT ====
async function loadContent() {
  try {
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}?ref=${branch}`;
    const res = await fetch(url);
    const data = await res.json();
    const content = atob(data.content);
    const json = JSON.parse(content);
    editor.innerText = json.text || "";
    editor.dataset.sha = data.sha;
    if(!token) editor.contentEditable = false;
  } catch(err) {
    editor.innerText = "Failed to load content.";
    console.error(err);
  }
}

// ==== SAVE CONTENT ====
saveBtn.addEventListener("click", async () => {
  if(!token) return;
  const contentText = editor.innerText;
  const sha = editor.dataset.sha;
  const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;

  const body = {
    message: "Update via live editor",
    content: btoa(JSON.stringify({ text: contentText })),
    sha: sha,
    branch: branch
  };

  try {
    const res = await fetch(url, {
      method: "PUT",
      headers: {
        "Authorization": `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(body)
    });

    const result = await res.json();
    if(result.content) {
      editor.dataset.sha = result.content.sha;
      status.innerText = "Saved successfully!";
    } else {
      console.error(result);
      status.innerText = "Error saving content.";
    }
  } catch(err) {
    console.error(err);
    status.innerText = "Error saving content.";
  }
});

// ==== INIT ====
promptAdmin();
loadContent();
</script>

</body>
</html>
